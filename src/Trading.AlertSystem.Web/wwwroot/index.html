<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“å‘Šè­¦ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .content {
            padding: 30px;
        }

        .alert-list {
            display: grid;
            gap: 20px;
        }

        .alert-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            background: white;
            transition: all 0.3s;
        }

        .alert-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .alert-card.disabled {
            opacity: 0.6;
            background: #f8f9fa;
        }

        .alert-card.triggered {
            border-left: 5px solid #28a745;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .alert-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .alert-symbol {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .alert-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }

        .alert-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-triggered {
            background: #d1ecf1;
            color: #0c5460;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š äº¤æ˜“å‘Šè­¦ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æ§ä»·æ ¼å˜åŒ–ï¼ŒåŠæ—¶æ”¶åˆ°Telegramé€šçŸ¥</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" onclick="showCreateModal()">â• åˆ›å»ºæ–°å‘Šè­¦</button>
            <button class="btn btn-success" onclick="testTelegram()">ğŸ“± æµ‹è¯•Telegram</button>
            <button class="btn btn-info" onclick="testTradeLocker()">ğŸ”Œ æµ‹è¯•TradeLocker</button>
            <button class="btn btn-info" onclick="checkNow()">ğŸ”„ ç«‹å³æ£€æŸ¥</button>
            <button class="btn btn-success" onclick="loadAlerts()">â™»ï¸ åˆ·æ–°åˆ—è¡¨</button>
        </div>

        <div class="content">
            <div id="alertList" class="alert-list">
                <div class="loading">
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘å‘Šè­¦æ¨¡æ€æ¡† -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">åˆ›å»ºæ–°å‘Šè­¦</h2>
            </div>
            <form id="alertForm">
                <input type="hidden" id="alertId">
                
                <div class="form-group">
                    <label class="form-label">å‘Šè­¦åç§°</label>
                    <input type="text" class="form-control" id="alertName" required>
                </div>

                <div class="form-group">
                    <label class="form-label">äº¤æ˜“å“ç§</label>
                    <input type="text" class="form-control" id="alertSymbol" placeholder="ä¾‹å¦‚: XAUUSD" required>
                </div>

                <div class="form-group">
                    <label class="form-label">å‘Šè­¦ç±»å‹</label>
                    <select class="form-control" id="alertType" onchange="updateFormFields()" required>
                        <option value="0">å›ºå®šä»·æ ¼</option>
                        <option value="1">EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿)</option>
                        <option value="2">MA (ç®€å•ç§»åŠ¨å¹³å‡çº¿)</option>
                    </select>
                </div>

                <div class="form-group" id="targetPriceGroup">
                    <label class="form-label">ç›®æ ‡ä»·æ ¼</label>
                    <input type="number" class="form-control" id="targetPrice" step="0.00001">
                </div>

                <div class="form-group" id="emaPeriodGroup" style="display: none;">
                    <label class="form-label">EMAå‘¨æœŸ</label>
                    <input type="number" class="form-control" id="emaPeriod" min="1" value="20">
                </div>

                <div class="form-group" id="maPeriodGroup" style="display: none;">
                    <label class="form-label">MAå‘¨æœŸ</label>
                    <input type="number" class="form-control" id="maPeriod" min="1" value="20">
                </div>

                <div class="form-group">
                    <label class="form-label">ä»·æ ¼æ–¹å‘</label>
                    <select class="form-control" id="direction" required>
                        <option value="0">ä¸Šç©¿ï¼ˆä»·æ ¼çªç ´ç›®æ ‡ï¼‰</option>
                        <option value="1">ä¸‹ç©¿ï¼ˆä»·æ ¼è·Œç ´ç›®æ ‡ï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">æ—¶é—´å‘¨æœŸ</label>
                    <select class="form-control" id="timeFrame">
                        <option value="M1">M1 (1åˆ†é’Ÿ)</option>
                        <option value="M5" selected>M5 (5åˆ†é’Ÿ)</option>
                        <option value="M15">M15 (15åˆ†é’Ÿ)</option>
                        <option value="M30">M30 (30åˆ†é’Ÿ)</option>
                        <option value="H1">H1 (1å°æ—¶)</option>
                        <option value="H4">H4 (4å°æ—¶)</option>
                        <option value="D1">D1 (æ—¥çº¿)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">æ¶ˆæ¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-control" id="messageTemplate" rows="3" 
                        placeholder="å¯ç”¨å˜é‡: {Symbol}, {Name}, {Price}, {Target}, {Direction}, {Time}"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Telegram Chat IDï¼ˆå¯é€‰ï¼‰</label>
                    <input type="number" class="form-control" id="telegramChatId" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤é…ç½®">
                </div>

                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" id="enabled" checked>
                        <label class="form-label" for="enabled">å¯ç”¨å‘Šè­¦</label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // åŠ è½½æ‰€æœ‰å‘Šè­¦
        async function loadAlerts() {
            try {
                const response = await fetch(`${API_BASE}/alerts`);
                const alerts = await response.json();
                
                const alertList = document.getElementById('alertList');
                
                if (alerts.length === 0) {
                    alertList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <h3>è¿˜æ²¡æœ‰å‘Šè­¦</h3>
                            <p>ç‚¹å‡»"åˆ›å»ºæ–°å‘Šè­¦"æŒ‰é’®å¼€å§‹è®¾ç½®ä»·æ ¼ç›‘æ§</p>
                        </div>
                    `;
                    return;
                }

                alertList.innerHTML = alerts.map(alert => createAlertCard(alert)).join('');
            } catch (error) {
                console.error('åŠ è½½å‘Šè­¦å¤±è´¥:', error);
                alert('åŠ è½½å‘Šè­¦å¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºå‘Šè­¦å¡ç‰‡HTML
        function createAlertCard(alert) {
            const typeText = ['å›ºå®šä»·æ ¼', 'EMA', 'MA'][alert.type];
            const directionText = alert.direction === 0 ? 'ä¸Šç©¿' : 'ä¸‹ç©¿';
            const statusClass = alert.isTriggered ? 'triggered' : (alert.enabled ? '' : 'disabled');
            const statusBadge = alert.isTriggered 
                ? '<span class="status-badge status-triggered">å·²è§¦å‘</span>'
                : (alert.enabled 
                    ? '<span class="status-badge status-active">å¯ç”¨</span>' 
                    : '<span class="status-badge status-disabled">ç¦ç”¨</span>');

            let targetText = '';
            if (alert.type === 0) {
                targetText = alert.targetPrice;
            } else if (alert.type === 1) {
                targetText = `EMA(${alert.emaPeriod})`;
            } else if (alert.type === 2) {
                targetText = `MA(${alert.maPeriod})`;
            }

            return `
                <div class="alert-card ${statusClass}">
                    <div class="alert-header">
                        <div>
                            <div class="alert-title">${alert.name}</div>
                            <div style="margin-top: 5px;">${statusBadge}</div>
                        </div>
                        <div class="alert-symbol">${alert.symbol}</div>
                    </div>
                    
                    <div class="alert-details">
                        <div class="detail-item">
                            <span class="detail-label">å‘Šè­¦ç±»å‹</span>
                            <span class="detail-value">${typeText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ç›®æ ‡å€¼</span>
                            <span class="detail-value">${targetText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ–¹å‘</span>
                            <span class="detail-value">${directionText}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">æ—¶é—´å‘¨æœŸ</span>
                            <span class="detail-value">${alert.timeFrame}</span>
                        </div>
                    </div>

                    ${alert.lastTriggeredAt ? `
                        <div style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                            æœ€åè§¦å‘: ${new Date(alert.lastTriggeredAt).toLocaleString('zh-CN')}
                        </div>
                    ` : ''}

                    <div class="alert-actions">
                        <button class="btn btn-primary" onclick="editAlert('${alert.id}')">ç¼–è¾‘</button>
                        ${alert.isTriggered ? `
                            <button class="btn btn-success" onclick="resetAlert('${alert.id}')">é‡ç½®</button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteAlert('${alert.id}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°å‘Šè­¦';
            document.getElementById('alertForm').reset();
            document.getElementById('alertId').value = '';
            updateFormFields();
            document.getElementById('alertModal').classList.add('show');
        }

        // ç¼–è¾‘å‘Šè­¦
        async function editAlert(id) {
            try {
                const response = await fetch(`${API_BASE}/alerts/${id}`);
                const alert = await response.json();

                document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å‘Šè­¦';
                document.getElementById('alertId').value = alert.id;
                document.getElementById('alertName').value = alert.name;
                document.getElementById('alertSymbol').value = alert.symbol;
                document.getElementById('alertType').value = alert.type;
                document.getElementById('targetPrice').value = alert.targetPrice || '';
                document.getElementById('emaPeriod').value = alert.emaPeriod || 20;
                document.getElementById('maPeriod').value = alert.maPeriod || 20;
                document.getElementById('direction').value = alert.direction;
                document.getElementById('timeFrame').value = alert.timeFrame;
                document.getElementById('messageTemplate').value = alert.messageTemplate || '';
                document.getElementById('telegramChatId').value = alert.telegramChatId || '';
                document.getElementById('enabled').checked = alert.enabled;

                updateFormFields();
                document.getElementById('alertModal').classList.add('show');
            } catch (error) {
                alert('åŠ è½½å‘Šè­¦æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
        function updateFormFields() {
            const type = parseInt(document.getElementById('alertType').value);
            
            document.getElementById('targetPriceGroup').style.display = type === 0 ? 'block' : 'none';
            document.getElementById('emaPeriodGroup').style.display = type === 1 ? 'block' : 'none';
            document.getElementById('maPeriodGroup').style.display = type === 2 ? 'block' : 'none';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('alertModal').classList.remove('show');
        }

        // æäº¤è¡¨å•
        document.getElementById('alertForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('alertId').value;
            const type = parseInt(document.getElementById('alertType').value);

            const data = {
                name: document.getElementById('alertName').value,
                symbol: document.getElementById('alertSymbol').value,
                type: type,
                direction: parseInt(document.getElementById('direction').value),
                timeFrame: document.getElementById('timeFrame').value,
                messageTemplate: document.getElementById('messageTemplate').value || null,
                telegramChatId: document.getElementById('telegramChatId').value ? 
                    parseInt(document.getElementById('telegramChatId').value) : null,
                enabled: document.getElementById('enabled').checked
            };

            if (type === 0) {
                data.targetPrice = parseFloat(document.getElementById('targetPrice').value);
            } else if (type === 1) {
                data.emaPeriod = parseInt(document.getElementById('emaPeriod').value);
            } else if (type === 2) {
                data.maPeriod = parseInt(document.getElementById('maPeriod').value);
            }

            try {
                const url = id ? `${API_BASE}/alerts/${id}` : `${API_BASE}/alerts`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    loadAlerts();
                    alert(id ? 'å‘Šè­¦æ›´æ–°æˆåŠŸ' : 'å‘Šè­¦åˆ›å»ºæˆåŠŸ');
                } else {
                    const error = await response.text();
                    alert('æ“ä½œå¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤å‘Šè­¦
        async function deleteAlert(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘Šè­¦å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/alerts/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadAlerts();
                    alert('å‘Šè­¦åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // é‡ç½®å‘Šè­¦
        async function resetAlert(id) {
            try {
                const response = await fetch(`${API_BASE}/alerts/${id}/reset`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadAlerts();
                    alert('å‘Šè­¦å·²é‡ç½®');
                } else {
                    alert('é‡ç½®å¤±è´¥');
                }
            } catch (error) {
                alert('é‡ç½®å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•Telegram
        async function testTelegram() {
            try {
                const response = await fetch(`${API_BASE}/system/test-telegram`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•TradeLocker
        async function testTradeLocker() {
            try {
                const response = await fetch(`${API_BASE}/system/test-tradelocker`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // ç«‹å³æ£€æŸ¥
        async function checkNow() {
            try {
                const response = await fetch(`${API_BASE}/system/check-now`, {
                    method: 'POST'
                });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å‘Šè­¦
        loadAlerts();
    </script>
</body>
</html>

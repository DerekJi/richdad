// UI äº¤äº’æ¨¡å—
const UI = {
    // æ˜¾ç¤ºåˆ›å»ºæ¨¡æ€æ¡†
    showCreateModal() {
        document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–°å‘Šè­¦';
        document.getElementById('alertForm').reset();
        document.getElementById('alertId').value = '';
        this.updateFormFields();
        this.autoGenerateNameAndMessage();
        document.getElementById('alertModal').classList.add('show');
    },

    // ç¼–è¾‘å‘Šè­¦
    async editAlert(id) {
        try {
            const alert = await AlertAPI.getById(id);

            // å¤„ç†æšä¸¾å­—ç¬¦ä¸²è½¬æ•°å­—
            let alertType = alert.type;
            if (typeof alertType === 'string') {
                const typeMap = { 'FixedPrice': 0, 'EMA': 1, 'MA': 2 };
                alertType = typeMap[alertType] ?? 0;
            }

            let direction = alert.direction;
            if (typeof direction === 'string') {
                direction = direction === 'Above' ? 0 : 1;
            }

            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å‘Šè­¦';
            document.getElementById('alertId').value = alert.id;
            document.getElementById('alertName').value = alert.name;
            document.getElementById('alertSymbol').value = alert.symbol;
            document.getElementById('alertType').value = alertType;
            document.getElementById('targetPrice').value = alert.targetPrice || '';
            document.getElementById('emaPeriod').value = alert.emaPeriod || 20;
            document.getElementById('maPeriod').value = alert.maPeriod || 20;
            document.getElementById('direction').value = direction;
            document.getElementById('timeFrame').value = alert.timeFrame;
            document.getElementById('messageTemplate').value = alert.messageTemplate || '';
            document.getElementById('telegramChatId').value = alert.telegramChatId || '';
            document.getElementById('enabled').checked = alert.enabled;

            this.updateFormFields();
            document.getElementById('alertModal').classList.add('show');
        } catch (error) {
            alert('åŠ è½½å‘Šè­¦æ•°æ®å¤±è´¥: ' + error.message);
        }
    },

    // æ›´æ–°è¡¨å•å­—æ®µæ˜¾ç¤º
    updateFormFields() {
        const type = parseInt(document.getElementById('alertType').value);

        document.getElementById('targetPriceGroup').style.display = type === 0 ? 'block' : 'none';
        document.getElementById('emaPeriodGroup').style.display = type === 1 ? 'block' : 'none';
        document.getElementById('maPeriodGroup').style.display = type === 2 ? 'block' : 'none';
        // å›ºå®šä»·æ ¼æ—¶ä¸éœ€è¦Kçº¿å‘¨æœŸï¼ˆåªæœ‰EMA/MAéœ€è¦ï¼‰
        document.getElementById('timeFrameGroup').style.display = type === 0 ? 'none' : 'block';
    },

    // è‡ªåŠ¨ç”Ÿæˆå‘Šè­¦åç§°å’Œæ¶ˆæ¯æ¨¡æ¿
    autoGenerateNameAndMessage() {
        const symbol = document.getElementById('alertSymbol').value.trim().toUpperCase();
        const type = parseInt(document.getElementById('alertType').value);
        const direction = parseInt(document.getElementById('direction').value);
        const timeFrame = document.getElementById('timeFrame').value;

        if (!symbol) return;

        // è·å–ç±»å‹æè¿°
        let typeDesc = '';
        let targetValue = '';

        if (type === 0) { // å›ºå®šä»·æ ¼
            const price = document.getElementById('targetPrice').value;
            if (price) {
                typeDesc = 'ä»·æ ¼';
                targetValue = price;
            }
        } else if (type === 1) { // EMA
            const period = document.getElementById('emaPeriod').value || 20;
            typeDesc = `EMA${period}`;
            targetValue = `EMA(${period})`;
        } else if (type === 2) { // MA
            const period = document.getElementById('maPeriod').value || 20;
            typeDesc = `MA${period}`;
            targetValue = `MA(${period})`;
        }

        // è·å–æ–¹å‘æè¿°
        const directionDesc = direction === 0 ? 'ä¸Šç©¿' : 'ä¸‹ç©¿';
        const directionIcon = direction === 0 ? 'â¬†ï¸' : 'â¬‡ï¸';

        // ç”Ÿæˆå‘Šè­¦åç§°
        if (typeDesc && targetValue) {
            const alertName = `${symbol} ${directionIcon} ${typeDesc}`;
            document.getElementById('alertName').value = alertName;

            // åªæœ‰å½“æ¶ˆæ¯æ¨¡æ¿ä¸ºç©ºæˆ–è€…æ˜¯ä¹‹å‰è‡ªåŠ¨ç”Ÿæˆçš„æ‰æ›´æ–°
            const messageTemplate = document.getElementById('messageTemplate');
            const currentMessage = messageTemplate.value.trim();

            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„æ¶ˆæ¯ï¼ˆåŒ…å«ç‰¹å®šæ ¼å¼ï¼‰
            const isAutoGenerated = !currentMessage ||
                                  currentMessage.includes('å‘Šè­¦è§¦å‘') ||
                                  currentMessage.includes('{Symbol}') ||
                                  currentMessage === '';

            if (isAutoGenerated) {
                // ç”Ÿæˆæ¶ˆæ¯æ¨¡æ¿
                let newMessage = '';
                if (type === 0) {
                    newMessage = `ğŸ”” ã€{Symbol}ã€‘å‘Šè­¦è§¦å‘ï¼\n\n` +
                               `ä»·æ ¼{Direction} ${targetValue}\n` +
                               `å½“å‰ä»·æ ¼ï¼š{Price}\n` +
                               `æ—¶é—´å‘¨æœŸï¼š${timeFrame}\n` +
                               `è§¦å‘æ—¶é—´ï¼š{Time}`;
                } else {
                    newMessage = `ğŸ”” ã€{Symbol}ã€‘å‘Šè­¦è§¦å‘ï¼\n\n` +
                               `ä»·æ ¼{Direction} ${typeDesc}\n` +
                               `å½“å‰ä»·æ ¼ï¼š{Price}\n` +
                               `æŒ‡æ ‡å€¼ï¼š{Target}\n` +
                               `æ—¶é—´å‘¨æœŸï¼š${timeFrame}\n` +
                               `è§¦å‘æ—¶é—´ï¼š{Time}`;
                }
                messageTemplate.value = newMessage;
            }
        }
    },

    // å…³é—­æ¨¡æ€æ¡†
    closeModal() {
        document.getElementById('alertModal').classList.remove('show');
    },

    // æµ‹è¯•Telegram
    async testTelegram() {
        try {
            const result = await SystemAPI.testTelegram();
            alert(result.message);
        } catch (error) {
            alert('æµ‹è¯•å¤±è´¥: ' + error.message);
        }
    },

    // æµ‹è¯•TradeLocker
    async testTradeLocker() {
        try {
            const result = await SystemAPI.testTradeLocker();

            if (result.success && result.account) {
                const account = result.account;
                const message = `âœ… TradeLockerè¿æ¥æˆåŠŸï¼\n\n` +
                    `è´¦æˆ·ID: ${account.accountId}\n` +
                    `è´¦æˆ·å: ${account.accountName}\n` +
                    `ä½™é¢: ${account.balance.toFixed(2)} ${account.currency}\n` +
                    `å‡€å€¼: ${account.equity.toFixed(2)} ${account.currency}\n` +
                    `å·²ç”¨ä¿è¯é‡‘: ${account.margin.toFixed(2)} ${account.currency}\n` +
                    `å¯ç”¨ä¿è¯é‡‘: ${account.freeMargin.toFixed(2)} ${account.currency}`;
                alert(message);
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('æµ‹è¯•å¤±è´¥: ' + error.message);
        }
    },

    // ç«‹å³æ£€æŸ¥
    async checkNow() {
        try {
            const result = await SystemAPI.checkNow();
            alert(result.message);
        } catch (error) {
            alert('æ£€æŸ¥å¤±è´¥: ' + error.message);
        }
    }
};
